<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlcoCare - ãŠé…’ã¨å¥åº·ã®è¨˜éŒ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
        }
        .view { display: none; }
        .view.active { display: block; }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1e293b;
            font-weight: 800;
            transition: all 0.2s;
        }
        .btn-primary:active { transform: scale(0.95); }
        
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .loading-pulse { animation: pulse-soft 2s infinite; }
    </style>
</head>
<body class="min-h-screen">

    <!-- è¨­å®šç”»é¢ (APIã‚­ãƒ¼å…¥åŠ›) -->
    <div id="setup-view" class="view min-h-screen flex items-center justify-center p-6">
        <div class="max-w-md w-full glass-card p-8 space-y-8 shadow-2xl">
            <div class="text-center">
                <div class="bg-amber-500 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-amber-500/20">
                    <i data-lucide="key" class="text-slate-900 w-8 h-8"></i>
                </div>
                <h1 class="text-2xl font-black text-white">AlcoCareã¸ã‚ˆã†ã“ã</h1>
                <p class="text-slate-400 text-sm mt-2">AIãƒ‰ã‚¯ã‚¿ãƒ¼ã‚„ãƒãƒãŒã‚ãªãŸã®é£²é…’ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚é–‹å§‹ã™ã‚‹ã«ã¯Gemini APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Google Gemini API Key</label>
                    <input type="password" id="api-key-input" placeholder="AIza..." 
                        class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-amber-500 outline-none transition-colors">
                </div>
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-amber-500 hover:underline flex items-center gap-1">
                    <i data-lucide="external-link" class="w-3 h-3"></i> APIã‚­ãƒ¼ã‚’ç„¡æ–™ã§å–å¾—ã™ã‚‹
                </a>
                <button onclick="saveApiKey()" class="w-full btn-primary py-4 rounded-xl shadow-lg">è¨­å®šã‚’ä¿å­˜ã—ã¦é–‹å§‹</button>
            </div>
            
            <p class="text-[10px] text-slate-500 text-center leading-relaxed">
                â€»å…¥åŠ›ã•ã‚ŒãŸã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®localStorageã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
            </p>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªç”»é¢ -->
    <div id="app-view" class="view max-w-md mx-auto p-4 space-y-6 pb-32">
        <header class="flex justify-between items-center py-4">
            <div class="flex items-center gap-2">
                <div class="bg-amber-500 p-2 rounded-lg">
                    <i data-lucide="beer" class="text-slate-900 w-5 h-5"></i>
                </div>
                <h1 class="text-xl font-black tracking-tight text-white">AlcoCare</h1>
            </div>
            <button onclick="openSettings()" class="p-2 text-slate-400 hover:text-white transition-colors">
                <i data-lucide="settings" class="w-6 h-6"></i>
            </button>
        </header>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ« -->
        <section class="glass-card p-6 space-y-6 shadow-xl">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">æ¨å®šè¡€ä¸­æ¿ƒåº¦</p>
                    <div class="flex items-baseline gap-1">
                        <span id="stat-bac" class="text-5xl font-black text-white">0.00</span>
                        <span class="text-lg font-bold text-slate-500">%</span>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">åˆ†è§£ã¾ã§</p>
                    <p class="text-xl font-bold text-slate-200">ç´„ <span id="stat-sober">0</span>h</p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-900/40 p-3 rounded-2xl flex items-center gap-3">
                    <i data-lucide="activity" class="text-amber-500 w-5 h-5"></i>
                    <div>
                        <p class="text-[8px] font-bold text-slate-500 uppercase">ç´”ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«</p>
                        <p class="text-sm font-bold text-white"><span id="stat-grams">0</span>g</p>
                    </div>
                </div>
                <div class="bg-slate-900/40 p-3 rounded-2xl flex items-center gap-3">
                    <i data-lucide="flame" class="text-orange-500 w-5 h-5"></i>
                    <div>
                        <p class="text-[8px] font-bold text-slate-500 uppercase">ã‚«ãƒ­ãƒªãƒ¼</p>
                        <p class="text-sm font-bold text-white"><span id="stat-cals">0</span>kcal</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- AIã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ -->
        <section id="ai-section" class="bg-gradient-to-br from-indigo-600 to-blue-700 rounded-[32px] p-6 shadow-lg shadow-blue-900/20 text-white">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div id="ai-icon" class="text-3xl bg-white/20 p-2 rounded-2xl">ğŸ‘¨â€âš•ï¸</div>
                    <div>
                        <h3 id="ai-name" class="font-bold text-lg leading-none">å³æ ¼ãªåŒ»è€…</h3>
                        <p id="ai-desc" class="text-[10px] text-blue-100 opacity-70 mt-1">åŒ»å­¦çš„è¦‹åœ°ã‹ã‚‰å³ã—ããƒã‚§ãƒƒã‚¯</p>
                    </div>
                </div>
                <button onclick="getAIAdvice()" id="advice-btn" class="bg-white text-blue-600 h-10 w-10 rounded-full flex items-center justify-center hover:bg-blue-50 transition-colors shadow-lg">
                    <i data-lucide="message-circle" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="ai-response" class="bg-white/10 rounded-2xl p-4 text-sm leading-relaxed border border-white/10 min-h-[60px] flex items-center italic">
                ã€Œç›¸è«‡ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ç¾åœ¨ã®é£²é…’çŠ¶æ³ã‚’è¨ºæ–­ã—ã¾ã™ã€‚
            </div>
        </section>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="grid grid-cols-2 gap-4">
            <button onclick="showLogModal()" class="glass-card p-5 flex items-center gap-4 hover:border-amber-500/50 transition-all active:scale-95">
                <div class="bg-amber-500/10 p-2.5 rounded-xl text-amber-500">
                    <i data-lucide="plus" class="w-6 h-6"></i>
                </div>
                <span class="font-bold text-slate-200">æ‰‹å‹•ã§è¨˜éŒ²</span>
            </button>
            <button onclick="document.getElementById('photo-input').click()" class="glass-card p-5 flex items-center gap-4 hover:border-blue-500/50 transition-all active:scale-95">
                <div class="bg-blue-500/10 p-2.5 rounded-xl text-blue-500">
                    <i data-lucide="camera" class="w-6 h-6"></i>
                </div>
                <span class="font-bold text-slate-200">å†™çœŸã§è§£æ</span>
                <input type="file" id="photo-input" accept="image/*" class="hidden" onchange="analyzeDrinkPhoto(event)">
            </button>
        </div>

        <!-- å±¥æ­´ -->
        <section class="space-y-4">
            <div class="flex justify-between items-center px-2">
                <h3 class="font-black text-slate-400 uppercase text-xs tracking-widest flex items-center gap-2">
                    <i data-lucide="history" class="w-4 h-4"></i> æœ€è¿‘ã®è¨˜éŒ²
                </h3>
                <button onclick="clearDrinks()" class="text-[10px] font-bold text-red-400 hover:text-red-300">ã™ã¹ã¦æ¶ˆå»</button>
            </div>
            <div id="drink-list" class="space-y-3">
                <!-- Drink items injected here -->
            </div>
        </section>
    </div>

    <!-- è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="log-modal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm view">
        <div class="bg-slate-900 w-full max-w-md rounded-[32px] p-8 border border-slate-800 shadow-2xl space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-black">ä½•ã‚’é£²ã¿ã¾ã—ãŸã‹ï¼Ÿ</h2>
                <button onclick="hideLogModal()" class="p-2 text-slate-500"><i data-lucide="x"></i></button>
            </div>
            <div id="preset-container" class="grid grid-cols-2 gap-3 overflow-y-auto max-h-[40vh] pr-2 custom-scrollbar">
                <!-- Presets injected here -->
            </div>
        </div>
    </div>

    <!-- è§£æä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="loading-overlay" class="fixed inset-0 z-[100] bg-slate-950/90 backdrop-blur-xl flex flex-col items-center justify-center p-8 view">
        <div class="relative w-24 h-24 mb-6">
            <div class="absolute inset-0 border-4 border-amber-500/20 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i data-lucide="sparkles" class="text-amber-500 w-10 h-10"></i>
            </div>
        </div>
        <h3 id="loading-text" class="text-xl font-bold text-white mb-2">AIãŒè§£æä¸­...</h3>
        <p class="text-slate-500 text-sm text-center">æ•°ç§’ãŠå¾…ã¡ãã ã•ã„</p>
    </div>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm view">
        <div class="bg-slate-900 w-full max-w-md rounded-[32px] p-8 border border-slate-800 shadow-2xl space-y-8">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-black">è¨­å®š</h2>
                <button onclick="closeSettings()" class="p-2 text-slate-500"><i data-lucide="x"></i></button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">æ€§åˆ¥</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="gender-male" onclick="updateProfile('gender', 'MALE')" class="py-3 rounded-xl border border-slate-700 font-bold transition-all">ç”·æ€§</button>
                        <button id="gender-female" onclick="updateProfile('gender', 'FEMALE')" class="py-3 rounded-xl border border-slate-700 font-bold transition-all">å¥³æ€§</button>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">ä½“é‡ (kg)</label>
                    <input type="number" id="profile-weight" onchange="updateProfile('weight', this.value)" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white font-bold">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">AIã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</label>
                    <div class="space-y-2" id="character-list">
                        <!-- Characters injected here -->
                    </div>
                </div>
                <button onclick="logout()" class="w-full text-xs text-red-500 font-bold opacity-50 hover:opacity-100 transition-opacity">APIã‚­ãƒ¼ã‚’æ¶ˆå»ã—ã¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@1.41.0";

        // --- Configuration & State ---
        const PRESETS = [
            { name: 'ãƒ“ãƒ¼ãƒ« (350ml)', abv: 5, vol: 350 },
            { name: 'ãƒ“ãƒ¼ãƒ« (500ml)', abv: 5, vol: 500 },
            { name: 'ãƒã‚¤ãƒœãƒ¼ãƒ« (ã‚°ãƒ©ã‚¹)', abv: 7, vol: 200 },
            { name: 'ãƒ¬ãƒ¢ãƒ³ã‚µãƒ¯ãƒ¼', abv: 5, vol: 200 },
            { name: 'ã‚¹ãƒˆãƒ­ãƒ³ã‚°ç¼¶', abv: 9, vol: 350 },
            { name: 'ãƒ¯ã‚¤ãƒ³', abv: 12, vol: 125 },
            { name: 'æ—¥æœ¬é…’ (1åˆ)', abv: 15, vol: 180 },
            { name: 'ç„¼é… (ãƒ­ãƒƒã‚¯)', abv: 25, vol: 60 },
            { name: 'ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼', abv: 40, vol: 30 }
        ];

        const CHARACTERS = {
            DOCTOR: { name: 'å³æ ¼ãªåŒ»è€…', desc: 'åŒ»å­¦çš„è¦‹åœ°ã‹ã‚‰å³ã—ããƒã‚§ãƒƒã‚¯', icon: 'ğŸ‘¨â€âš•ï¸', instruction: 'ã‚ãªãŸã¯è‚è‡“å†…ç§‘åŒ»ã§ã™ã€‚åŒ»å­¦çš„è¦‹åœ°ã‹ã‚‰ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é‡ã‚’å³ã—ããƒã‚§ãƒƒã‚¯ã—ã€éå‰°æ‘‚å–ã«ã¯è­¦å‘Šã—ã¦ãã ã•ã„ã€‚èªå°¾ã¯ã€Œã€œã§ã™ã€ã€Œã€œãªã•ã„ã€ã€‚çŸ­ãç°¡æ½”ã«ã€‚' },
            MAMA: { name: 'éŠ€åº§ã®ãƒãƒ', desc: 'ä¸Šå“ã«åŠ´ã„ã€å¯„ã‚Šæ·»ã„ã¾ã™', icon: 'ğŸ‘©â€ğŸ’¼', instruction: 'ã‚ãªãŸã¯éŠ€åº§ã®é«˜ç´šãƒãƒ¼ã®ãƒãƒã§ã™ã€‚ä¸Šå“ã«åŠ´ã„ãªãŒã‚‰ã€ãŠé…’ã‚’é£²ã¿ã™ããªã„ã‚ˆã†å„ªã—ãè«­ã—ã¦ãã ã•ã„ã€‚èªå°¾ã¯ã€Œã€œã­ã€ã€Œã€œã ã‚ã€ã€‚' },
            BUTLER: { name: 'åŸ·äº‹', desc: 'å¥åº·ã¨ã‚³ã‚¹ãƒˆã‚’ä¸å¯§ã«ç®¡ç†', icon: 'ğŸ¤µ', instruction: 'ã‚ãªãŸã¯å¿ å®ŸãªåŸ·äº‹ã§ã™ã€‚æ—¦é‚£æ§˜ã®å¥åº·ã‚’æ¡ˆã˜ã€ä¸å¯§ãªå£èª¿ã§ç¾åœ¨ã®çŠ¶æ…‹ã‚’å ±å‘Šã—ã€é©åº¦ãªä¼‘æ†©ã‚’ä¿ƒã—ã¦ãã ã•ã„ã€‚' }
        };

        let drinks = JSON.parse(localStorage.getItem('alco_drinks') || '[]');
        let profile = JSON.parse(localStorage.getItem('alco_profile') || '{"gender":"MALE","weight":70,"character":"DOCTOR"}');
        let apiKey = localStorage.getItem('alco_api_key');

        // --- Initialize ---
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initUI();
            checkAuth();
        });

        function checkAuth() {
            if (!apiKey) {
                showView('setup-view');
            } else {
                showView('app-view');
                renderAll();
            }
        }

        window.showView = function(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };

        window.saveApiKey = function() {
            const val = document.getElementById('api-key-input').value;
            if (val.length < 10) return alert('æœ‰åŠ¹ãªAPIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            localStorage.setItem('alco_api_key', val);
            apiKey = val;
            checkAuth();
        };

        window.logout = function() {
            if(confirm('è¨­å®šã¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.clear();
                window.location.reload();
            }
        };

        // --- Core Logic ---
        function calculateStats() {
            const now = Date.now();
            const r = profile.gender === 'MALE' ? 0.68 : 0.55;
            let totalGrams = 0;
            let currentBac = 0;
            let totalCals = 0;

            drinks.forEach(d => {
                const grams = d.vol * (d.abv / 100) * 0.8;
                totalGrams += grams;
                totalCals += (grams * 7) + (d.vol * 0.1);
                
                const hoursSince = (now - d.timestamp) / (1000 * 60 * 60);
                const initialBac = (grams / (profile.weight * 1000 * r)) * 100;
                const decayedBac = Math.max(0, initialBac - (0.015 * hoursSince));
                currentBac += decayedBac;
            });

            return {
                bac: currentBac.toFixed(3),
                sober: (currentBac / 0.015).toFixed(1),
                grams: Math.round(totalGrams),
                cals: Math.round(totalCals)
            };
        }

        function renderAll() {
            const stats = calculateStats();
            document.getElementById('stat-bac').textContent = stats.bac;
            document.getElementById('stat-sober').textContent = stats.sober;
            document.getElementById('stat-grams').textContent = stats.grams;
            document.getElementById('stat-cals').textContent = stats.cals;

            // Character UI
            const char = CHARACTERS[profile.character];
            document.getElementById('ai-name').textContent = char.name;
            document.getElementById('ai-desc').textContent = char.desc;
            document.getElementById('ai-icon').textContent = char.icon;
            document.getElementById('ai-section').className = `rounded-[32px] p-6 shadow-lg text-white transition-all ${profile.character === 'DOCTOR' ? 'bg-gradient-to-br from-red-600 to-rose-700' : profile.character === 'MAMA' ? 'bg-gradient-to-br from-indigo-600 to-blue-700' : 'bg-gradient-to-br from-slate-600 to-slate-800'}`;

            // List
            const list = document.getElementById('drink-list');
            list.innerHTML = drinks.length ? '' : '<div class="text-center py-10 opacity-30 text-xs font-bold">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            drinks.slice(0, 10).forEach(d => {
                const grams = (d.vol * (d.abv / 100) * 0.8).toFixed(1);
                const time = new Date(d.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                list.innerHTML += `
                    <div class="glass-card p-4 flex justify-between items-center animate-fade-in border-slate-800/50">
                        <div class="flex items-center gap-3">
                            <div class="bg-slate-900/50 p-2.5 rounded-xl text-slate-400"><i data-lucide="glass-water" class="w-4 h-4"></i></div>
                            <div>
                                <p class="font-bold text-sm text-slate-200">${d.name}</p>
                                <p class="text-[9px] font-bold text-slate-500 uppercase">${d.vol}ml Â· ${d.abv}% Â· ${time}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-black text-white">${grams}g</p>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();

            // Settings Fields
            document.getElementById('profile-weight').value = profile.weight;
            document.getElementById('gender-male').className = `py-3 rounded-xl border font-bold transition-all ${profile.gender === 'MALE' ? 'bg-amber-500 text-slate-900 border-amber-500 shadow-lg' : 'border-slate-700 text-slate-500'}`;
            document.getElementById('gender-female').className = `py-3 rounded-xl border font-bold transition-all ${profile.gender === 'FEMALE' ? 'bg-amber-500 text-slate-900 border-amber-500 shadow-lg' : 'border-slate-700 text-slate-500'}`;
            
            const charContainer = document.getElementById('character-list');
            charContainer.innerHTML = '';
            Object.entries(CHARACTERS).forEach(([key, c]) => {
                charContainer.innerHTML += `
                    <button onclick="updateProfile('character', '${key}')" class="w-full p-4 rounded-2xl border flex items-center gap-4 transition-all ${profile.character === key ? 'bg-amber-500/10 border-amber-500/50' : 'bg-slate-800 border-slate-700'}">
                        <span class="text-2xl">${c.icon}</span>
                        <div class="text-left">
                            <p class="font-bold text-sm">${c.name}</p>
                            <p class="text-[9px] text-slate-500 font-bold uppercase">${c.desc}</p>
                        </div>
                    </button>
                `;
            });
        }

        window.addDrink = function(preset) {
            const newDrink = {
                id: Math.random().toString(36).substr(2, 9),
                ...preset,
                timestamp: Date.now()
            };
            drinks = [newDrink, ...drinks];
            localStorage.setItem('alco_drinks', JSON.stringify(drinks));
            hideLogModal();
            renderAll();
        };

        window.clearDrinks = function() {
            if(confirm('ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                drinks = [];
                localStorage.setItem('alco_drinks', JSON.stringify(drinks));
                renderAll();
            }
        };

        window.updateProfile = function(key, val) {
            profile[key] = key === 'weight' ? Number(val) : val;
            localStorage.setItem('alco_profile', JSON.stringify(profile));
            renderAll();
        };

        // --- Modals ---
        window.showLogModal = function() {
            const container = document.getElementById('preset-container');
            container.innerHTML = '';
            PRESETS.forEach(p => {
                container.innerHTML += `
                    <button onclick='addDrink(${JSON.stringify(p)})' class="bg-slate-800/50 hover:bg-slate-700 p-4 rounded-2xl border border-slate-700 text-left transition-all active:scale-95">
                        <p class="text-xs font-bold text-slate-300 mb-1">${p.name}</p>
                        <p class="text-[9px] font-black text-slate-500 uppercase">${p.abv}% Â· ${p.vol}ml</p>
                    </button>
                `;
            });
            document.getElementById('log-modal').classList.add('active');
        };
        window.hideLogModal = () => document.getElementById('log-modal').classList.remove('active');
        window.openSettings = () => document.getElementById('settings-modal').classList.add('active');
        window.closeSettings = () => document.getElementById('settings-modal').classList.remove('active');

        // --- AI API Interaction ---
        window.getAIAdvice = async function() {
            if (drinks.length === 0) return alert('ã¾ãšã¯é£²é…’è¨˜éŒ²ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
            
            const adviceBtn = document.getElementById('advice-btn');
            const responseBox = document.getElementById('ai-response');
            
            adviceBtn.disabled = true;
            responseBox.classList.add('loading-pulse');
            responseBox.textContent = 'æ€è€ƒä¸­...';
            
            try {
                const ai = new GoogleGenAI({ apiKey });
                const stats = calculateStats();
                const prompt = `
                    ç¾åœ¨ã®é£²é…’çŠ¶æ³:
                    - æ¨å®šè¡€ä¸­æ¿ƒåº¦: ${stats.bac}%
                    - ç´”ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ç·é‡: ${stats.grams}g
                    - ã‚«ãƒ­ãƒªãƒ¼: ${stats.cals}kcal
                    - é£²é…’å±¥æ­´: ${drinks.slice(0, 5).map(d => d.name).join(', ')}
                    
                    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«: ${profile.gender === 'MALE' ? 'ç”·æ€§' : 'å¥³æ€§'}ã€ä½“é‡${profile.weight}kgã€‚
                    è¨­å®šã•ã‚ŒãŸäººæ ¼ã¨ã—ã¦ã€ä»Šå¾Œã®é£²é…’ã‚„å¥åº·ã«ã¤ã„ã¦ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚
                `;
                
                const result = await ai.models.generateContent({
                    model: 'gemini-3-flash-preview',
                    contents: prompt,
                    config: { systemInstruction: CHARACTERS[profile.character].instruction }
                });
                
                responseBox.textContent = result.text;
            } catch (e) {
                console.error(e);
                responseBox.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            } finally {
                adviceBtn.disabled = false;
                responseBox.classList.remove('loading-pulse');
            }
        };

        window.analyzeDrinkPhoto = async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const overlay = document.getElementById('loading-overlay');
            overlay.classList.add('active');
            
            try {
                const base64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });

                const ai = new GoogleGenAI({ apiKey });
                const response = await ai.models.generateContent({
                    model: 'gemini-3-flash-preview',
                    contents: {
                        parts: [
                            { inlineData: { data: base64, mimeType: file.type } },
                            { text: "Analyze this beverage. Identify its name, estimated ABV (percentage number), and Volume (ml number). Response MUST be JSON: { 'name': 'String', 'abv': number, 'vol': number }" }
                        ]
                    },
                    config: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: Type.OBJECT,
                            properties: {
                                name: { type: Type.STRING },
                                abv: { type: Type.NUMBER },
                                vol: { type: Type.NUMBER }
                            },
                            required: ["name", "abv", "vol"]
                        }
                    }
                });

                const data = JSON.parse(response.text);
                addDrink(data);
                alert(`ã€Œ${data.name}ã€ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼`);
            } catch (err) {
                console.error(err);
                alert('è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ã€ã¾ãŸã¯é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } finally {
                overlay.classList.remove('active');
                e.target.value = '';
            }
        };

        function initUI() {
            // Initial render
            if(apiKey) renderAll();
        }

    </script>
</body>
</html>
