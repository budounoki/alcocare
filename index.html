<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlcoCare - AI Health Guard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #020617;
            color: #f8fafc;
            overflow-x: hidden;
        }
        .glass-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 32px;
        }
        .advice-bubble {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 1.25rem;
        }
        .advice-bubble::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 20px;
            border-width: 8px 8px 8px 0;
            border-style: solid;
            border-color: transparent rgba(255, 255, 255, 0.05) transparent transparent;
        }
        .status-badge {
            animation: pulse-slow 3s infinite;
        }
        @keyframes pulse-slow {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.9; }
        }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .theme-DOCTOR { --primary: #3b82f6; --bg-gradient: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); }
        .theme-MAMA { --primary: #a855f7; --bg-gradient: linear-gradient(135deg, #4c1d95 0%, #7c3aed 100%); }
        .theme-BUTLER { --primary: #64748b; --bg-gradient: linear-gradient(135deg, #0f172a 0%, #334155 100%); }

        #password-screen.hidden { display: none; }
        #main-app.hidden { display: none; }
    </style>
</head>
<body class="min-h-screen pb-12">

    <div id="password-screen" class="fixed inset-0 z-[300] bg-slate-950 flex flex-col items-center justify-center p-8 text-center">
        <div class="bg-blue-600/20 p-6 rounded-[40px] mb-8">
            <i data-lucide="lock" class="text-blue-400 w-12 h-12"></i>
        </div>
        <h2 class="text-2xl font-black text-white mb-6">èªè¨¼ãŒå¿…è¦ã§ã™</h2>
        <div class="w-full max-w-xs space-y-4">
            <input type="password" id="auth-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" class="w-full bg-slate-900 border border-white/10 rounded-2xl px-6 py-4 text-center text-white font-black tracking-widest outline-none focus:border-blue-500 transition-all">
            <button onclick="checkAuth()" class="w-full py-4 bg-blue-600 text-white font-black rounded-2xl shadow-xl shadow-blue-500/20 hover:bg-blue-500 active:scale-95 transition-all">
                ã‚¢ã‚¯ã‚»ã‚¹
            </button>
            <p id="auth-error" class="text-rose-500 text-xs font-bold hidden">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</p>
        </div>
    </div>

    <div id="error-display" class="hidden fixed top-0 left-0 right-0 z-[400] bg-rose-600 p-4 text-white text-center font-bold text-sm shadow-2xl flex items-center justify-center gap-2">
        <i data-lucide="alert-circle" class="w-4 h-4"></i>
        <span id="error-message"></span>
        <button onclick="hideError()" class="ml-4 opacity-50 hover:opacity-100"><i data-lucide="x" class="w-4 h-4"></i></button>
    </div>

    <div id="main-app" class="max-w-md mx-auto p-5 space-y-6 pt-10 hidden">
        <header class="flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-3 rounded-2xl shadow-xl shadow-blue-500/20">
                    <i data-lucide="activity" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tighter text-white">AlcoCare AI</h1>
                    <span class="text-[9px] font-bold text-slate-500 uppercase tracking-widest flex items-center gap-1">
                        <span id="api-status-dot" class="w-1.5 h-1.5 rounded-full bg-slate-600"></span> ENGINE STATUS
                    </span>
                </div>
            </div>
            <div class="flex gap-2">
                <a href="https://note.com" target="_blank" class="p-3 glass-card text-slate-400 hover:text-white transition-all flex items-center gap-2">
                    <i data-lucide="external-link" class="w-5 h-5"></i>
                    <span class="text-[10px] font-black uppercase">Note</span>
                </a>
                <button onclick="toggleSettings()" class="p-3 glass-card text-slate-400 hover:text-white transition-all">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                </button>
            </div>
        </header>

        <div id="conclusion-container" class="hidden animate-fade-in">
            <div id="status-badge" class="status-badge w-full py-4 px-6 rounded-3xl text-center font-black text-xl shadow-2xl">
                çŠ¶æ…‹ï¼š<span id="conclusion-text">è§£æä¸­...</span>
            </div>
        </div>

        <section class="glass-card p-6 grid grid-cols-2 gap-4 relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-blue-500/10 blur-3xl rounded-full"></div>
            <div class="col-span-2 flex justify-between items-center mb-2">
                <p class="text-[11px] font-black text-slate-500 tracking-[0.2em] uppercase">Stats Dashboard</p>
                <span class="text-[10px] font-bold text-blue-400 bg-blue-500/10 px-2 py-0.5 rounded-full">LIVE</span>
            </div>
            <div class="space-y-1">
                <p class="text-[10px] font-bold text-slate-500 uppercase">è¡€ä¸­æ¿ƒåº¦</p>
                <p class="text-3xl font-black text-white"><span id="val-bac">0.00</span><span class="text-sm ml-1 text-slate-500">%</span></p>
            </div>
            <div class="space-y-1 text-right">
                <p class="text-[10px] font-bold text-slate-500 uppercase">åˆ†è§£å®Œäº†</p>
                <p class="text-3xl font-black text-white"><span id="val-sober">0</span><span class="text-sm ml-1 text-slate-500">h</span></p>
            </div>
            <div class="bg-slate-900/40 p-3 rounded-2xl border border-white/5">
                <p class="text-[9px] font-bold text-slate-500 uppercase">ç´”ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«</p>
                <p class="text-lg font-black text-white"><span id="val-grams">0</span>g</p>
            </div>
            <div class="bg-slate-900/40 p-3 rounded-2xl border border-white/5">
                <p class="text-[9px] font-bold text-slate-500 uppercase">ç´¯è¨ˆæ”¯å‡º</p>
                <p class="text-lg font-black text-white">Â¥<span id="val-spend">0</span></p>
            </div>
        </section>

        <section id="ai-section" class="hidden transition-all duration-500 transform scale-95 opacity-0">
            <div id="character-card" class="rounded-[40px] p-6 shadow-2xl relative overflow-hidden border border-white/10">
                <div id="card-decor" class="absolute top-0 right-0 p-6 opacity-20 pointer-events-none"></div>
                <div class="relative z-10 space-y-6">
                    <div class="flex items-center gap-5">
                        <div id="char-icon-container" class="w-16 h-16 rounded-2xl flex items-center justify-center text-4xl shadow-inner bg-white/10 backdrop-blur-md">ğŸ‘¨â€âš•ï¸</div>
                        <div>
                            <h3 id="char-name" class="text-xl font-black text-white leading-none mb-2">å³æ ¼ãªåŒ»è€…</h3>
                            <p id="char-title" class="text-[10px] font-bold text-white/60 tracking-widest uppercase italic">Medical Expert</p>
                        </div>
                    </div>
                    <div class="advice-bubble text-white/90 text-sm leading-relaxed font-medium">
                        <span id="advice-text">èª­ã¿è¾¼ã¿ä¸­...</span>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-4 border border-white/5">
                            <p class="text-[9px] font-bold text-white/50 uppercase mb-1">è‚è‡“è² è·æŒ‡æ•°</p>
                            <div class="flex items-end gap-2">
                                <span id="val-liver-load" class="text-2xl font-black text-white">0</span>
                                <span class="text-xs font-bold text-white/50 mb-1">%</span>
                            </div>
                            <div class="w-full bg-white/10 h-1.5 rounded-full mt-2">
                                <div id="bar-liver-load" class="h-full bg-white rounded-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-4 border border-white/5">
                            <p class="text-[9px] font-bold text-white/50 uppercase mb-1">è„±æ°´ãƒªã‚¹ã‚¯</p>
                            <div id="val-dehydration" class="text-lg font-black text-white uppercase tracking-tighter">NONE</div>
                            <p class="text-[8px] text-white/40 mt-1 italic">â€»ãƒã‚§ã‚¤ã‚µãƒ¼æ¨å¥¨</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-2 gap-4">
            <button onclick="openManualInput()" class="glass-card p-6 flex flex-col gap-3 group active:scale-95 transition-all text-left">
                <div class="bg-blue-500/10 w-12 h-12 rounded-2xl flex items-center justify-center text-blue-400 group-hover:bg-blue-500 group-hover:text-white">
                    <i data-lucide="plus"></i>
                </div>
                <span class="font-black text-slate-200">æ‰‹å‹•è¨˜éŒ²</span>
            </button>
            <button onclick="triggerCamera()" class="glass-card p-6 flex flex-col gap-3 group active:scale-95 transition-all text-left">
                <div class="bg-purple-500/10 w-12 h-12 rounded-2xl flex items-center justify-center text-purple-400 group-hover:bg-purple-500 group-hover:text-white">
                    <i data-lucide="camera"></i>
                </div>
                <span class="font-black text-slate-200">AIç”»åƒè§£æ</span>
                <input type="file" id="photo-input" accept="image/*" class="hidden" onchange="processPhoto(event)">
            </button>
        </div>

        <button id="main-ask-btn" onclick="askAI()" class="w-full py-5 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-[32px] text-white font-black text-lg shadow-2xl shadow-blue-500/20 flex items-center justify-center gap-3 hover:scale-[1.02] active:scale-95 transition-all">
            <i data-lucide="sparkles"></i> AIãƒ‰ã‚¯ã‚¿ãƒ¼ã«ç›¸è«‡ã™ã‚‹
        </button>

        <section class="space-y-4 pt-4">
            <div class="flex justify-between items-center px-2">
                <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Drinking Log History</h3>
                <button onclick="clearLogs()" class="text-[10px] font-bold text-rose-500/50 hover:text-rose-500 transition-colors">ALL RESET</button>
            </div>
            <div id="history-list" class="space-y-3"></div>
        </section>
    </div>

    <div id="modal-settings" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-sm transition-all opacity-0 pointer-events-none">
        <div class="bg-slate-900 w-full max-w-md rounded-[40px] p-8 border border-white/5 shadow-2xl space-y-8 transform scale-90 transition-transform">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-black text-white">Settings</h2>
                <button onclick="toggleSettings()" class="p-2 text-slate-500 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-6 custom-scroll overflow-y-auto max-h-[60vh] pr-2">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="setProfile('gender', 'MALE')" id="g-male" class="py-4 rounded-2xl border-2 font-black transition-all">ç”·æ€§</button>
                    <button onclick="setProfile('gender', 'FEMALE')" id="g-female" class="py-4 rounded-2xl border-2 font-black transition-all">å¥³æ€§</button>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest">ä½“é‡ (kg)</label>
                    <input type="number" id="weight-input" oninput="setProfile('weight', this.value)" class="w-full bg-slate-950 border border-white/10 rounded-2xl px-5 py-4 text-white font-black text-xl outline-none focus:border-blue-500">
                </div>
                <div class="space-y-3" id="role-list"></div>
            </div>
            <button onclick="toggleSettings()" class="w-full py-5 bg-blue-600 text-white font-black rounded-3xl text-lg shadow-xl shadow-blue-500/20">è¨­å®šã‚’å®Œäº†</button>
        </div>
    </div>

    <div id="modal-drinks" class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm transition-all opacity-0 pointer-events-none">
        <div class="bg-slate-900 w-full max-w-md rounded-[40px] p-8 border border-white/5 shadow-2xl space-y-6 transform translate-y-20 transition-transform">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-black text-white">é£²ã¿ç‰©ã‚’é¸æŠ</h2>
                <button onclick="closeModal('modal-drinks')" class="p-2 text-slate-500 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div id="preset-grid" class="grid grid-cols-2 gap-3 max-h-[50vh] overflow-y-auto pr-2 custom-scroll"></div>
        </div>
    </div>

    <div id="global-loader" class="fixed inset-0 z-[200] bg-slate-950/90 flex flex-col items-center justify-center p-8 transition-opacity opacity-0 pointer-events-none text-center">
        <div class="w-20 h-20 border-4 border-blue-500/20 border-t-blue-500 rounded-full animate-spin mb-6"></div>
        <p class="text-white font-black text-xl animate-pulse">AIãŒè§£æä¸­...</p>
        <p class="text-slate-500 text-xs mt-2 font-bold uppercase tracking-widest">Processing Data</p>
    </div>

    <script type="module">
        import { GoogleGenAI } from "https://esm.sh/@google/genai@1.41.0";

        const GEMINI_API_KEY = "AIzaSyBtlKNcuoi-moqCDyWyayxgkiwM8rBjsYs"; 

        const AUTH_PASS = "alco2026";
        const PRESETS = [
            { name: 'ãƒ“ãƒ¼ãƒ« (350ml)', abv: 5, vol: 350, price: 350 },
            { name: 'ãƒ“ãƒ¼ãƒ« (500ml)', abv: 5, vol: 500, price: 500 },
            { name: 'ãƒ¬ãƒ¢ãƒ³ã‚µãƒ¯ãƒ¼', abv: 5, vol: 350, price: 400 },
            { name: 'ãƒã‚¤ãƒœãƒ¼ãƒ«', abv: 7, vol: 350, price: 450 },
            { name: 'ã‚¹ãƒˆãƒ­ãƒ³ã‚°ç¼¶', abv: 9, vol: 350, price: 200 },
            { name: 'æ—¥æœ¬é…’ (1åˆ)', abv: 15, vol: 180, price: 800 },
            { name: 'ãƒ¯ã‚¤ãƒ³ (ã‚°ãƒ©ã‚¹)', abv: 12, vol: 125, price: 600 },
            { name: 'ç„¼é… (ãƒ­ãƒƒã‚¯)', abv: 25, vol: 90, price: 500 },
            { name: 'ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼ (ã‚·ãƒ³ã‚°ãƒ«)', abv: 40, vol: 30, price: 1000 }
        ];

        const ROLES = {
            DOCTOR: {
                name: 'å³æ ¼ãªåŒ»è€…', icon: 'ğŸ‘¨â€âš•ï¸', title: 'Medical Expert',
                decor: '<i data-lucide="heart-pulse" class="w-16 h-16 text-blue-200"></i>',
                status_colors: { NORMAL: 'bg-emerald-500', CAUTION: 'bg-amber-500', DANGER: 'bg-rose-600' },
                prompt: 'ã‚ãªãŸã¯è‚è‡“å°‚é–€åŒ»ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é£²é…’ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€åŒ»å­¦çš„è¦‹åœ°ã‹ã‚‰éå¸¸ã«å³ã—ãè¨ºæ–­ã—ã¦ãã ã•ã„ã€‚'
            },
            MAMA: {
                name: 'éŠ€åº§ã®ãƒãƒ', icon: 'ğŸ‘©â€ğŸ’¼', title: 'Elegant Hostess',
                decor: '<i data-lucide="star" class="w-16 h-16 text-purple-200"></i>',
                status_colors: { NORMAL: 'bg-pink-500', CAUTION: 'bg-fuchsia-600', DANGER: 'bg-purple-800' },
                prompt: 'ã‚ãªãŸã¯éŠ€åº§ã®ãƒãƒã§ã™ã€‚ä¸Šå“ã«ã€ã§ã‚‚é£²ã¿ã™ãã«ã¯å³ã—ãæ³¨æ„ã—ã¦ãã ã•ã„ã€‚'
            },
            BUTLER: {
                name: 'å¿ å®ŸãªåŸ·äº‹', icon: 'ğŸ¤µ', title: 'Professional Butler',
                decor: '<i data-lucide="clock" class="w-16 h-16 text-slate-300"></i>',
                status_colors: { NORMAL: 'bg-slate-500', CAUTION: 'bg-indigo-600', DANGER: 'bg-slate-900' },
                prompt: 'ã‚ãªãŸã¯å¿ å®ŸãªåŸ·äº‹ã§ã™ã€‚æ—¦é‚£æ§˜ã‚’åŠ´ã„ã¤ã¤ã€å®¢è¦³çš„ãªå ±å‘Šã‚’ã—ã¦ãã ã•ã„ã€‚'
            }
        };

        let state = {
            drinks: JSON.parse(localStorage.getItem('alcare_logs_v3') || '[]'),
            profile: JSON.parse(localStorage.getItem('alcare_prof_v3') || '{"gender":"MALE","weight":70,"character":"DOCTOR"}'),
            authenticated: sessionStorage.getItem('alcare_auth') === 'true'
        };

        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            if (state.authenticated) showMainApp();
            checkAPIStatus();
            refreshUI();
            syncSettingsUI();
        });

        function checkAPIStatus() {
            const dot = document.getElementById('api-status-dot');
            if (GEMINI_API_KEY && GEMINI_API_KEY.startsWith("AIza")) {
                dot.className = "w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]";
            } else {
                dot.className = "w-1.5 h-1.5 rounded-full bg-rose-500 shadow-[0_0_8px_rgba(244,63,94,0.8)]";
            }
        }

        window.checkAuth = () => {
            const input = document.getElementById('auth-input').value;
            if (input === AUTH_PASS) {
                state.authenticated = true;
                sessionStorage.setItem('alcare_auth', 'true');
                showMainApp();
            } else {
                document.getElementById('auth-error').classList.remove('hidden');
            }
        };

        function showMainApp() {
            document.getElementById('password-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            refreshUI();
        }

        function refreshUI() {
            const stats = calcStats();
            document.getElementById('val-bac').textContent = stats.bac;
            document.getElementById('val-sober').textContent = stats.sober;
            document.getElementById('val-grams').textContent = stats.grams;
            document.getElementById('val-spend').textContent = stats.spend.toLocaleString();

            const list = document.getElementById('history-list');
            list.innerHTML = state.drinks.length ? '' : '<div class="text-center py-10 glass-card text-slate-600 font-bold text-xs italic">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            
            state.drinks.forEach(d => {
                const alc = (d.vol * (d.abv / 100) * 0.8).toFixed(1);
                const item = document.createElement('div');
                item.className = "glass-card p-5 flex justify-between items-center animate-fade-in group";
                item.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="bg-slate-900 w-12 h-12 flex items-center justify-center rounded-2xl text-slate-500 group-hover:text-blue-400">
                            <i data-lucide="glass-water" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <p class="font-bold text-slate-100">${d.name}</p>
                            <p class="text-[9px] font-black text-slate-600 uppercase mt-0.5">${new Date(d.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} Â· ${d.abv}%</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <p class="text-xl font-black text-white tracking-tighter">${alc}g</p>
                        <button onclick="deleteLog(${d.id})" class="text-rose-500 opacity-0 group-hover:opacity-100 transition-all p-2">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>`;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function calcStats() {
            const now = Date.now();
            const r = state.profile.gender === 'MALE' ? 0.68 : 0.55;
            let totalGrams = 0, currentBac = 0, totalSpend = 0;
            state.drinks.forEach(d => {
                const grams = d.vol * (d.abv / 100) * 0.8;
                totalGrams += grams;
                totalSpend += (d.price || 0);
                const hours = (now - d.timestamp) / (1000 * 60 * 60);
                const initial = (grams / (state.profile.weight * 1000 * r)) * 100;
                currentBac += Math.max(0, initial - (0.015 * hours));
            });
            return { bac: currentBac.toFixed(2), sober: (currentBac / 0.015).toFixed(1), grams: Math.round(totalGrams), spend: totalSpend };
        }

        window.openManualInput = () => {
            const grid = document.getElementById('preset-grid');
            grid.innerHTML = '';
            PRESETS.forEach(p => {
                const b = document.createElement('button');
                b.className = "bg-slate-800/40 p-5 rounded-3xl border border-white/5 text-left hover:bg-slate-800 active:scale-95 transition-all";
                b.innerHTML = `<p class="text-sm font-black text-slate-200">${p.name}</p><p class="text-[9px] font-black text-slate-600 uppercase mt-1">Â¥${p.price} / ${p.abv}%</p>`;
                b.onclick = () => { addLog(p); closeModal('modal-drinks'); };
                grid.appendChild(b);
            });
            openModal('modal-drinks');
        };

        window.addLog = (item) => {
            state.drinks.unshift({ ...item, id: Date.now(), timestamp: Date.now() });
            saveAndRefresh();
        };

        window.deleteLog = (id) => {
            state.drinks = state.drinks.filter(d => d.id !== id);
            saveAndRefresh();
        };

        window.clearLogs = () => { 
            if (confirm('å…¨ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { 
                state.drinks = []; 
                saveAndRefresh(); 
            } 
        };

        function saveAndRefresh() {
            localStorage.setItem('alcare_logs_v3', JSON.stringify(state.drinks));
            refreshUI();
        }

        window.askAI = async () => {
            if (!GEMINI_API_KEY || !GEMINI_API_KEY.startsWith("AIza")) return showError("APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„");
            if (!state.drinks.length) return alert("è¨˜éŒ²ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚");
            
            showLoader(true);
            try {
                const genAI = new GoogleGenAI(GEMINI_API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                const s = calcStats();
                const role = ROLES[state.profile.character];

                const prompt = `${role.prompt} ãƒ‡ãƒ¼ã‚¿: è¡€ä¸­æ¿ƒåº¦ ${s.bac}%, ç´”ã‚¢ãƒ«ã‚³ãƒ¼ãƒ« ${s.grams}g, æ”¯å‡º Â¥${s.spend}ã€‚ä»¥ä¸‹ã®JSONå½¢å¼ã ã‘ã§ç­”ãˆã¦ãã ã•ã„: {"conclusion": "ä¸€è¨€çµè«–", "status": "NORMAL/CAUTION/DANGER", "advice": "æœ¬æ–‡", "liver_load": 0, "dehydration": "LOW"}`;

                const result = await model.generateContent(prompt);
                const text = result.response.text();
                const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                updateAdviceUI(JSON.parse(jsonText));
            } catch (err) { 
                showError("AIã‚¨ãƒ©ãƒ¼: " + err.message); 
            } finally { 
                showLoader(false); 
            }
        };

        function updateAdviceUI(data) {
            const roleKey = state.profile.character;
            const role = ROLES[roleKey];
            document.body.className = `min-h-screen pb-12 theme-${roleKey}`;
            document.getElementById('character-card').style.background = `var(--bg-gradient)`;
            document.getElementById('status-badge').className = `status-badge w-full py-4 px-6 rounded-3xl text-center font-black text-xl shadow-2xl text-white ${role.status_colors[data.status] || 'bg-slate-700'}`;
            document.getElementById('conclusion-text').textContent = data.conclusion;
            document.getElementById('advice-text').textContent = data.advice;
            document.getElementById('val-liver-load').textContent = data.liver_load;
            document.getElementById('bar-liver-load').style.width = `${data.liver_load}%`;
            document.getElementById('val-dehydration').textContent = data.dehydration;
            document.getElementById('ai-section').classList.remove('hidden', 'scale-95', 'opacity-0');
            document.getElementById('conclusion-container').classList.remove('hidden');
            lucide.createIcons();
        }

        window.openModal = (id) => { document.getElementById(id).classList.add('opacity-100', 'pointer-events-auto'); };
        window.closeModal = (id) => { document.getElementById(id).classList.remove('opacity-100', 'pointer-events-auto'); };
        window.toggleSettings = () => { const m = document.getElementById('modal-settings'); m.classList.contains('opacity-100') ? closeModal('modal-settings') : openModal('modal-settings'); };
        window.setProfile = (k, v) => { state.profile[k] = k === 'weight' ? Number(v) : v; localStorage.setItem('alcare_prof_v3', JSON.stringify(state.profile)); syncSettingsUI(); refreshUI(); };
        function syncSettingsUI() {
            const list = document.getElementById('role-list'); list.innerHTML = '';
            Object.entries(ROLES).forEach(([key, r]) => {
                const active = state.profile.character === key;
                list.innerHTML += `<button onclick="setProfile('character', '${key}')" class="w-full p-4 rounded-2xl border flex items-center gap-4 transition-all ${active ? 'bg-blue-600/20 border-blue-600/50' : 'bg-slate-950/50 border-white/5'}"><span class="text-2xl">${r.icon}</span><div class="text-left"><p class="font-black text-sm text-slate-100">${r.name}</p></div></button>`;
            });
        }
        function showLoader(show) { document.getElementById('global-loader').classList.toggle('opacity-100', show); document.getElementById('global-loader').classList.toggle('pointer-events-auto', show); }
        window.showError = (msg) => { document.getElementById('error-display').classList.remove('hidden'); document.getElementById('error-message').textContent = msg; };
        window.hideError = () => { document.getElementById('error-display').classList.add('hidden'); };
    </script>
</body>
</html>
