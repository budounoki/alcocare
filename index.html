<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlcoCare - ãŠé…’ã¨å¥åº·ã®è¨˜éŒ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            overflow-x: hidden;
        }
        .view { display: none; }
        .view.active { display: block; animation: fade-in 0.3s ease-out; }
        
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 28px;
        }
        
        .btn-amber {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1e293b;
            font-weight: 800;
            box-shadow: 0 10px 15px -3px rgba(245, 158, 11, 0.3);
        }
        
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .6; }
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen selection:bg-amber-500/30">

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªç”»é¢ -->
    <div id="app-view" class="view active max-w-md mx-auto p-5 space-y-6 pb-32">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="flex justify-between items-center py-4">
            <div class="flex items-center gap-3">
                <div class="bg-amber-500 p-2.5 rounded-2xl shadow-lg shadow-amber-500/20">
                    <i data-lucide="beer" class="text-slate-900 w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tighter text-white">AlcoCare</h1>
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Healthcare AI</p>
                </div>
            </div>
            <button onclick="toggleSettings()" class="p-2.5 glass-card text-slate-400 hover:text-white transition-all active:scale-90">
                <i data-lucide="user-cog" class="w-6 h-6"></i>
            </button>
        </header>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
        <section class="glass-card p-6 space-y-6 shadow-2xl relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-amber-500/10 blur-3xl rounded-full"></div>
            <div class="flex justify-between items-start relative z-10">
                <div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 flex items-center gap-1">
                        <i data-lucide="activity" class="w-3 h-3 text-amber-500"></i> æ¨å®šè¡€ä¸­æ¿ƒåº¦
                    </p>
                    <div class="flex items-baseline gap-1">
                        <span id="display-bac" class="text-6xl font-black text-white tracking-tighter">0.00</span>
                        <span class="text-xl font-bold text-slate-500">%</span>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1"> sober in</p>
                    <p class="text-2xl font-black text-slate-200"><span id="display-sober" class="text-blue-400">0</span>h</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 relative z-10">
                <div class="bg-slate-900/40 p-4 rounded-2xl border border-white/5 flex items-center gap-3">
                    <div class="p-2 bg-rose-500/20 rounded-lg text-rose-500">
                        <i data-lucide="dna" class="w-4 h-4"></i>
                    </div>
                    <div>
                        <p class="text-[8px] font-bold text-slate-500 uppercase tracking-tighter">ç´”ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«</p>
                        <p class="text-sm font-black text-white"><span id="display-grams">0</span>g</p>
                    </div>
                </div>
                <div class="bg-slate-900/40 p-4 rounded-2xl border border-white/5 flex items-center gap-3">
                    <div class="p-2 bg-orange-500/20 rounded-lg text-orange-500">
                        <i data-lucide="zap" class="w-4 h-4"></i>
                    </div>
                    <div>
                        <p class="text-[8px] font-bold text-slate-500 uppercase tracking-tighter">æ¨å®šã‚«ãƒ­ãƒªãƒ¼</p>
                        <p class="text-sm font-black text-white"><span id="display-cals">0</span>kcal</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ -->
        <section id="ai-advisor" class="relative group rounded-[32px] overflow-hidden shadow-xl p-1">
            <div id="ai-bg" class="absolute inset-0 bg-gradient-to-br from-indigo-600 to-blue-800 transition-all duration-500"></div>
            <div class="relative z-10 p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div id="ai-avatar" class="text-4xl bg-white/20 p-3 rounded-2xl backdrop-blur-md shadow-inner">ğŸ‘¨â€âš•ï¸</div>
                        <div>
                            <h3 id="ai-role-name" class="font-black text-lg text-white leading-none">å³æ ¼ãªåŒ»è€…</h3>
                            <p id="ai-role-desc" class="text-[10px] text-white/60 font-medium mt-1">å¥åº·ãƒªã‚¹ã‚¯ã‚’ç§‘å­¦çš„ã«è¨ºæ–­</p>
                        </div>
                    </div>
                    <button onclick="fetchAIAdvice()" id="ai-btn" class="bg-white text-indigo-600 h-12 w-12 rounded-full flex items-center justify-center hover:scale-105 active:scale-95 transition-all shadow-xl">
                        <i data-lucide="sparkles" class="w-6 h-6"></i>
                    </button>
                </div>
                <div id="ai-output" class="bg-white/10 backdrop-blur-md rounded-2xl p-5 text-sm leading-relaxed text-white/90 border border-white/10 min-h-[80px] flex items-center italic">
                    ãŠé…’ã‚’è¨˜éŒ²ã—ãŸå¾Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å¥åº·çŠ¶æ…‹ã‚’ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¾ã™ã€‚
                </div>
            </div>
        </section>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="grid grid-cols-2 gap-4">
            <button onclick="openLogModal()" class="glass-card p-6 flex items-center gap-4 hover:border-amber-500/50 transition-all active:scale-95 group">
                <div class="bg-amber-500/10 p-3 rounded-2xl text-amber-500 group-hover:bg-amber-500 group-hover:text-white transition-colors">
                    <i data-lucide="plus-circle" class="w-7 h-7"></i>
                </div>
                <span class="font-black text-slate-200">æ‰‹å‹•è¿½åŠ </span>
            </button>
            <button onclick="triggerCamera()" class="glass-card p-6 flex items-center gap-4 hover:border-blue-500/50 transition-all active:scale-95 group">
                <div class="bg-blue-500/10 p-3 rounded-2xl text-blue-500 group-hover:bg-blue-500 group-hover:text-white transition-colors">
                    <i data-lucide="camera" class="w-7 h-7"></i>
                </div>
                <span class="font-black text-slate-200">AIè§£æ</span>
                <input type="file" id="camera-input" accept="image/*" class="hidden" onchange="processImage(event)">
            </button>
        </div>

        <!-- å±¥æ­´ãƒªã‚¹ãƒˆ -->
        <section class="space-y-4">
            <div class="flex justify-between items-center px-2">
                <h3 class="font-black text-slate-500 uppercase text-[10px] tracking-[0.2em] flex items-center gap-2">
                    <i data-lucide="history" class="w-4 h-4"></i> æœ€è¿‘ã®ãƒ‰ãƒªãƒ³ã‚¯ãƒ­ã‚°
                </h3>
                <button onclick="resetHistory()" class="text-[10px] font-bold text-rose-400 hover:text-rose-300 transition-colors">å…¨æ¶ˆå»</button>
            </div>
            <div id="history-container" class="space-y-3">
                <!-- Log items injected here -->
            </div>
        </section>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: è¨˜éŒ²è¿½åŠ  -->
    <div id="log-modal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm transition-opacity opacity-0 pointer-events-none">
        <div class="bg-slate-900 w-full max-w-md rounded-[40px] p-8 border border-white/5 shadow-2xl space-y-6 transform translate-y-10 transition-transform">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-black text-white tracking-tight">ä½•ã‚’é£²ã¿ã¾ã—ãŸã‹ï¼Ÿ</h2>
                <button onclick="closeLogModal()" class="p-2 text-slate-500 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div id="presets-grid" class="grid grid-cols-2 gap-3 overflow-y-auto max-h-[50vh] pr-2 custom-scroll">
                <!-- Presets injected here -->
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: è¨­å®š -->
    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm transition-opacity opacity-0 pointer-events-none">
        <div class="bg-slate-900 w-full max-w-md rounded-[40px] p-8 border border-white/5 shadow-2xl space-y-8 transform scale-95 transition-transform">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-black text-white">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
                <button onclick="toggleSettings()" class="p-2 text-slate-500"><i data-lucide="x"></i></button>
            </div>
            
            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="setGender('MALE')" id="btn-male" class="py-4 rounded-2xl border-2 font-black transition-all">ç”·æ€§</button>
                    <button onclick="setGender('FEMALE')" id="btn-female" class="py-4 rounded-2xl border-2 font-black transition-all">å¥³æ€§</button>
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">ä½“é‡ (kg)</label>
                    <input type="number" id="input-weight" oninput="saveWeight(this.value)" class="w-full bg-slate-800/50 border border-white/5 rounded-2xl px-6 py-4 text-white font-black text-xl outline-none focus:border-amber-500">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3">AIã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼</label>
                    <div class="space-y-2" id="char-selector">
                        <!-- Characters injected here -->
                    </div>
                </div>
            </div>
            <button onclick="toggleSettings()" class="w-full py-4 btn-amber rounded-2xl text-lg">è¨­å®šã‚’å®Œäº†ã™ã‚‹</button>
        </div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‰ç”»é¢ -->
    <div id="loading-layer" class="fixed inset-0 z-[100] bg-slate-950/90 backdrop-blur-2xl flex flex-col items-center justify-center p-8 transition-opacity opacity-0 pointer-events-none">
        <div class="relative w-32 h-32 mb-8">
            <div class="absolute inset-0 border-4 border-amber-500/10 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i data-lucide="wand-2" class="text-amber-500 w-12 h-12"></i>
            </div>
        </div>
        <h3 id="loading-label" class="text-2xl font-black text-white mb-2">AIãŒç”»åƒã‚’è§£æä¸­</h3>
        <p class="text-slate-500 text-sm font-bold animate-pulse">æ•°ç§’ãŠå¾…ã¡ãã ã•ã„...</p>
    </div>

    <script type="module">
        import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@1.41.0";

        // --- Data Definitions ---
        const BEVERAGES = [
            { name: 'ãƒ“ãƒ¼ãƒ« (350ml)', abv: 5, vol: 350 },
            { name: 'ãƒ“ãƒ¼ãƒ« (500ml)', abv: 5, vol: 500 },
            { name: 'ãƒ¬ãƒ¢ãƒ³ã‚µãƒ¯ãƒ¼', abv: 5, vol: 250 },
            { name: 'ãƒã‚¤ãƒœãƒ¼ãƒ«', abv: 7, vol: 200 },
            { name: 'ã‚¹ãƒˆãƒ­ãƒ³ã‚°ç¼¶', abv: 9, vol: 350 },
            { name: 'æ—¥æœ¬é…’ (1åˆ)', abv: 15, vol: 180 },
            { name: 'ãƒ¯ã‚¤ãƒ³ (ã‚°ãƒ©ã‚¹)', abv: 12, vol: 125 },
            { name: 'ç„¼é… (ãƒ­ãƒƒã‚¯)', abv: 25, vol: 60 },
            { name: 'ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼ (ã‚·ãƒ³ã‚°ãƒ«)', abv: 40, vol: 30 }
        ];

        const ROLES = {
            DOCTOR: {
                name: 'å³æ ¼ãªåŒ»è€…',
                icon: 'ğŸ‘¨â€âš•ï¸',
                desc: 'å¥åº·ãƒªã‚¹ã‚¯ã‚’ç§‘å­¦çš„ã«è¨ºæ–­',
                color: 'from-rose-600 to-red-800',
                prompt: 'ã‚ãªãŸã¯è‚è‡“å†…ç§‘åŒ»ã§ã™ã€‚ç¾åœ¨ã®é£²é…’ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€åŒ»å­¦çš„ã«ãƒªã‚¹ã‚¯ã‚’è¨ºæ–­ã—ã€å³ã—ã„è¨€è‘‰ã§å¥åº·ç®¡ç†ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã—ã¦ãã ã•ã„ã€‚å°‚é–€ç”¨èªã‚’äº¤ãˆã¤ã¤ç°¡æ½”ã«ã€‚èªå°¾ã¯ã€Œã€œã§ã™ã€ã€Œã€œã—ãªã•ã„ã€ã€‚'
            },
            MAMA: {
                name: 'éŠ€åº§ã®ãƒãƒ',
                icon: 'ğŸ‘©â€ğŸ’¼',
                desc: 'ä¸Šå“ã«åŠ´ã„ã€å¯„ã‚Šæ·»ã„ã¾ã™',
                color: 'from-indigo-600 to-blue-800',
                prompt: 'ã‚ãªãŸã¯éŠ€åº§ã®é«˜ç´šãƒãƒ¼ã®ãƒãƒã§ã™ã€‚ä¸Šå“ã§å„ªé›…ãªå£èª¿ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç–²ã‚Œã‚’åŠ´ã„ãªãŒã‚‰ã€ãŠé…’ã‚’é£²ã¿ã™ããªã„ã‚ˆã†å„ªã—ãè«­ã—ã¦ãã ã•ã„ã€‚èªå°¾ã¯ã€Œã€œã­ã€ã€Œã€œã ã‚ã€ã€‚'
            },
            BUTLER: {
                name: 'å¿ å®ŸãªåŸ·äº‹',
                icon: 'ğŸ¤µ',
                desc: 'æ—¦é‚£æ§˜ã®çŠ¶æ…‹ã‚’ä¸å¯§ã«å ±å‘Š',
                color: 'from-slate-700 to-slate-900',
                prompt: 'ã‚ãªãŸã¯å¿ å®ŸãªåŸ·äº‹ã§ã™ã€‚æ—¦é‚£æ§˜ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã®é£²é…’é‡ã‚’æŠŠæ¡ã—ã€å†·é™ã‹ã¤ä¸å¯§ãªå£èª¿ã§ç¾åœ¨ã®çŠ¶æ…‹ã‚’å ±å‘Šã—ã€é©åº¦ãªä¼‘æ¯ã‚„ãƒã‚§ã‚¤ã‚µãƒ¼ã‚’å‹§ã‚ã¦ãã ã•ã„ã€‚éå¸¸ã«ä¸å¯§ãªè¨€è‘‰é£ã„ã§ã€‚'
            }
        };

        // --- State Management ---
        let state = {
            drinks: JSON.parse(localStorage.getItem('alcare_history') || '[]'),
            profile: JSON.parse(localStorage.getItem('alcare_profile') || '{"gender":"MALE","weight":70,"character":"DOCTOR"}')
        };

        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

        // --- UI Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            refreshUI();
            initSelectors();
        });

        function refreshUI() {
            const stats = calculateMetrics();
            document.getElementById('display-bac').textContent = stats.bac;
            document.getElementById('display-sober').textContent = stats.sober;
            document.getElementById('display-grams').textContent = stats.grams;
            document.getElementById('display-cals').textContent = stats.cals;

            // AI Advisor Theme
            const role = ROLES[state.profile.character];
            document.getElementById('ai-role-name').textContent = role.name;
            document.getElementById('ai-role-desc').textContent = role.desc;
            document.getElementById('ai-avatar').textContent = role.icon;
            document.getElementById('ai-bg').className = `absolute inset-0 bg-gradient-to-br ${role.color} transition-all duration-500`;

            // List History
            const container = document.getElementById('history-container');
            container.innerHTML = state.drinks.length ? '' : '<div class="text-center py-12 text-slate-600 font-bold italic border-2 border-dashed border-slate-800/50 rounded-3xl">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            
            state.drinks.slice(0, 5).forEach(d => {
                const alc = (d.vol * (d.abv / 100) * 0.8).toFixed(1);
                const time = new Date(d.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                container.innerHTML += `
                    <div class="glass-card p-5 flex justify-between items-center animate-fade-in">
                        <div class="flex items-center gap-4">
                            <div class="bg-slate-900/50 p-2.5 rounded-xl text-slate-400"><i data-lucide="glass-water" class="w-5 h-5"></i></div>
                            <div>
                                <p class="font-bold text-slate-100">${d.name}</p>
                                <p class="text-[9px] font-black text-slate-500 uppercase tracking-wider">${time} Â· ${d.abv}% Â· ${d.vol}ml</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xl font-black text-white">${alc}g</p>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
            
            // Sync settings UI
            document.getElementById('input-weight').value = state.profile.weight;
            updateSettingsUI();
        }

        function calculateMetrics() {
            const now = Date.now();
            const r = state.profile.gender === 'MALE' ? 0.68 : 0.55;
            let totalGrams = 0;
            let currentBac = 0;
            let totalCals = 0;

            state.drinks.forEach(d => {
                const grams = d.vol * (d.abv / 100) * 0.8;
                totalGrams += grams;
                totalCals += (grams * 7) + (d.vol * 0.1);
                
                const hoursPassed = (now - d.timestamp) / (1000 * 60 * 60);
                const initialBac = (grams / (state.profile.weight * 1000 * r)) * 100;
                const decay = 0.015 * hoursPassed;
                currentBac += Math.max(0, initialBac - decay);
            });

            return {
                bac: currentBac.toFixed(2),
                sober: (currentBac / 0.015).toFixed(1),
                grams: Math.round(totalGrams),
                cals: Math.round(totalCals)
            };
        }

        // --- Interaction Handlers ---
        window.openLogModal = () => {
            const grid = document.getElementById('presets-grid');
            grid.innerHTML = '';
            BEVERAGES.forEach(b => {
                const btn = document.createElement('button');
                btn.className = "bg-slate-800/50 hover:bg-slate-700 p-5 rounded-3xl border border-white/5 text-left transition-all active:scale-95";
                btn.innerHTML = `<p class="text-sm font-black text-slate-200 mb-1">${b.name}</p><p class="text-[9px] font-black text-slate-500 uppercase">${b.abv}% / ${b.vol}ml</p>`;
                btn.onclick = () => logDrink(b);
                grid.appendChild(btn);
            });
            const modal = document.getElementById('log-modal');
            modal.classList.add('opacity-100', 'pointer-events-auto');
            modal.querySelector('div').classList.remove('translate-y-10');
        };

        window.closeLogModal = () => {
            const modal = document.getElementById('log-modal');
            modal.classList.remove('opacity-100', 'pointer-events-auto');
            modal.querySelector('div').classList.add('translate-y-10');
        };

        window.logDrink = (item) => {
            state.drinks.unshift({
                id: Date.now().toString(36),
                ...item,
                timestamp: Date.now()
            });
            localStorage.setItem('alcare_history', JSON.stringify(state.drinks));
            closeLogModal();
            refreshUI();
        };

        window.resetHistory = () => {
            if(confirm('è¨˜éŒ²ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) {
                state.drinks = [];
                localStorage.setItem('alcare_history', '[]');
                refreshUI();
            }
        };

        window.toggleSettings = () => {
            const modal = document.getElementById('settings-modal');
            const isActive = modal.classList.toggle('opacity-100');
            modal.classList.toggle('pointer-events-auto', isActive);
            modal.querySelector('div').classList.toggle('scale-95', !isActive);
        };

        window.setGender = (g) => {
            state.profile.gender = g;
            saveProfile();
            updateSettingsUI();
        };

        window.saveWeight = (w) => {
            state.profile.weight = Number(w) || 70;
            saveProfile();
        };

        window.selectCharacter = (c) => {
            state.profile.character = c;
            saveProfile();
            updateSettingsUI();
            refreshUI();
        };

        function saveProfile() {
            localStorage.setItem('alcare_profile', JSON.stringify(state.profile));
        }

        function updateSettingsUI() {
            const m = document.getElementById('btn-male');
            const f = document.getElementById('btn-female');
            const isM = state.profile.gender === 'MALE';
            m.className = `py-4 rounded-2xl border-2 font-black transition-all ${isM ? 'bg-amber-500 border-amber-500 text-slate-900 shadow-lg' : 'border-slate-800 text-slate-500'}`;
            f.className = `py-4 rounded-2xl border-2 font-black transition-all ${!isM ? 'bg-amber-500 border-amber-500 text-slate-900 shadow-lg' : 'border-slate-800 text-slate-500'}`;
            
            const charList = document.getElementById('char-selector');
            charList.innerHTML = '';
            Object.entries(ROLES).forEach(([key, r]) => {
                const active = state.profile.character === key;
                charList.innerHTML += `
                    <button onclick="selectCharacter('${key}')" class="w-full p-4 rounded-2xl border-2 flex items-center gap-4 transition-all ${active ? 'bg-amber-500/10 border-amber-500/50' : 'bg-slate-800/50 border-white/5'}">
                        <span class="text-2xl">${r.icon}</span>
                        <div class="text-left">
                            <p class="font-black text-sm text-slate-200">${r.name}</p>
                            <p class="text-[9px] font-bold text-slate-500 uppercase">${r.desc}</p>
                        </div>
                    </button>
                `;
            });
        }

        // --- AI API Operations ---
        window.fetchAIAdvice = async () => {
            if (!state.drinks.length) return alert('ã¾ãšã¯é£²é…’ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚');
            const output = document.getElementById('ai-output');
            const btn = document.getElementById('ai-btn');
            const icon = btn.querySelector('i');
            
            output.innerHTML = 'æ€è€ƒä¸­...';
            output.classList.add('pulse-animation');
            btn.disabled = true;

            try {
                const metrics = calculateMetrics();
                const historyStr = state.drinks.slice(0, 5).map(d => `${d.name}`).join(', ');
                const prompt = `ç¾åœ¨ã®çŠ¶æ³: æ¨å®šè¡€ä¸­æ¿ƒåº¦${metrics.bac}%ã€ç·ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«${metrics.grams}gã€æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼${metrics.cals}kcalã€‚æœ€è¿‘é£²ã‚“ã ã‚‚ã®: ${historyStr}ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§: ${state.profile.gender === 'MALE' ? 'ç”·æ€§' : 'å¥³æ€§'}ã€ä½“é‡${state.profile.weight}kgã€‚ã‚ãªãŸã®å½¹å‰²ã«å¿œã˜ãŸè¨ºæ–­ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æ—¥æœ¬èªã§æä¾›ã—ã¦ãã ã•ã„ã€‚`;
                
                const response = await ai.models.generateContent({
                    model: 'gemini-3-flash-preview',
                    contents: prompt,
                    config: { systemInstruction: ROLES[state.profile.character].prompt }
                });
                
                output.innerHTML = response.text;
            } catch (err) {
                console.error(err);
                output.innerHTML = 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
            } finally {
                output.classList.remove('pulse-animation');
                btn.disabled = false;
            }
        };

        window.triggerCamera = () => document.getElementById('camera-input').click();

        window.processImage = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const loader = document.getElementById('loading-layer');
            loader.classList.add('opacity-100', 'pointer-events-auto');

            try {
                const base64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });

                const response = await ai.models.generateContent({
                    model: 'gemini-3-flash-preview',
                    contents: {
                        parts: [
                            { inlineData: { data: base64, mimeType: file.type } },
                            { text: "ã“ã®ãŠé…’ã®ç”»åƒã‚’è§£æã—ã¦ãã ã•ã„ã€‚ç¨®é¡ï¼ˆå•†å“åï¼‰ã€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«åº¦æ•°(%)ã€å†…å®¹é‡(ml)ã‚’æ¨å®šã—ã€å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§ã®ã¿å›ç­”ã—ã¦ãã ã•ã„ã€‚{\"name\": \"åå‰\", \"abv\": 5.0, \"vol\": 350}" }
                        ]
                    },
                    config: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: Type.OBJECT,
                            properties: {
                                name: { type: Type.STRING },
                                abv: { type: Type.NUMBER },
                                vol: { type: Type.NUMBER }
                            },
                            required: ["name", "abv", "vol"]
                        }
                    }
                });

                const data = JSON.parse(response.text);
                logDrink(data);
                alert(`AIãŒè§£æã—ã¾ã—ãŸ: ${data.name} (${data.abv}%, ${data.vol}ml)`);
            } catch (err) {
                console.error(err);
                alert('è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãŠé…’ãŒã¯ã£ãã‚Šå†™ã‚‹ã‚ˆã†ã«æ’®å½±ã—ã¦ãã ã•ã„ã€‚');
            } finally {
                loader.classList.remove('opacity-100', 'pointer-events-auto');
                event.target.value = '';
            }
        };

        function initSelectors() {
            // Initial call to update settings UI states
            updateSettingsUI();
        }
    </script>
</body>
</html>
